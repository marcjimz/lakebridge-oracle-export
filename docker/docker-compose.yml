version: '3.8'

# Oracle Lakebridge Extractor - Docker Compose Configuration
#
# Three Oracle container options available via profiles:
#   --profile slim   : gvenzl/oracle-xe (recommended for testing, no login required)
#   --profile xe     : Oracle XE 21c (official, requires Oracle SSO login)
#   --profile 23ai   : Oracle 23ai Free (newest, requires Oracle SSO login)
#
# Usage:
#   docker compose --profile slim up -d
#   docker compose --profile xe up -d
#   docker compose --profile 23ai up -d

services:
  # Option 1: gvenzl/oracle-xe (Recommended for testing)
  # - Lightweight (~3GB), fast startup (~2 min), no Oracle login required
  oracle-slim:
    image: gvenzl/oracle-xe:21-slim
    profiles: ["slim"]
    container_name: oracle-lakebridge
    environment:
      - ORACLE_PASSWORD=${ORACLE_PWD:-LakebridgeTest123!}
      - ORACLE_CHARACTERSET=${ORACLE_CHARACTERSET:-AL32UTF8}
      - APP_USER=${HEALTHCARE_USER:-healthcare}
      - APP_USER_PASSWORD=${HEALTHCARE_PWD:-healthcare123}
    ports:
      - "1521:1521"
    volumes:
      - ./init-scripts:/container-entrypoint-initdb.d:ro
      - oracle-data-slim:/opt/oracle/oradata
    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped

  # Option 2: Oracle XE 21c (Official)
  # - Full Oracle XE (~8GB), requires Oracle SSO login to pull
  # - docker login container-registry.oracle.com
  oracle-xe:
    image: container-registry.oracle.com/database/express:latest
    profiles: ["xe"]
    container_name: oracle-lakebridge
    environment:
      - ORACLE_PWD=${ORACLE_PWD:-LakebridgeTest123!}
      - ORACLE_CHARACTERSET=${ORACLE_CHARACTERSET:-AL32UTF8}
    ports:
      - "1521:1521"
      - "5500:5500"  # Enterprise Manager
    volumes:
      - ./init-scripts:/opt/oracle/scripts/startup:ro
      - oracle-data-xe:/opt/oracle/oradata
    shm_size: '2g'
    healthcheck:
      test: ["CMD", "sqlplus", "-L", "sys/${ORACLE_PWD:-LakebridgeTest123!}@//localhost:1521/XEPDB1 as sysdba", "@/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 15
      start_period: 120s
    restart: unless-stopped

  # Option 3: Oracle 23ai Free (Newest)
  # - Latest Oracle features (~8GB), requires Oracle SSO login
  # - docker login container-registry.oracle.com
  oracle-23ai:
    image: container-registry.oracle.com/database/free:latest
    profiles: ["23ai"]
    container_name: oracle-lakebridge
    environment:
      - ORACLE_PWD=${ORACLE_PWD:-LakebridgeTest123!}
      - ORACLE_CHARACTERSET=${ORACLE_CHARACTERSET:-AL32UTF8}
    ports:
      - "1521:1521"
      - "5500:5500"  # Enterprise Manager
    volumes:
      - ./init-scripts:/opt/oracle/scripts/startup:ro
      - oracle-data-23ai:/opt/oracle/oradata
    shm_size: '2g'
    healthcheck:
      test: ["CMD", "sqlplus", "-L", "sys/${ORACLE_PWD:-LakebridgeTest123!}@//localhost:1521/FREEPDB1 as sysdba", "@/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 15
      start_period: 120s
    restart: unless-stopped

volumes:
  oracle-data-slim:
    name: oracle-lakebridge-data-slim
  oracle-data-xe:
    name: oracle-lakebridge-data-xe
  oracle-data-23ai:
    name: oracle-lakebridge-data-23ai

networks:
  default:
    name: oracle-lakebridge-network
